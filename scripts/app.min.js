angular.module("govDomains",['ngAria']).service('DataService',function($http){this.getData=function(type){if(sessionStorage.getItem(type)===null){var url=(type==="federal")?'fed.json':'nofed-statesonly.json';$http.get('data/'+url).then(function(response){sessionStorage.setItem(type,JSON.stringify(response.data));return response.data;});}else{return JSON.parse(sessionStorage.getItem(type));}};}).controller('mainCtrl',function($scope,$compile,DataService){$scope.getItems=function(type){$scope.select=type;$scope.active=true;$scope.optionType=(type==='federal')?'agency':'state';$scope.filterType=null;$scope.radioVal=null;$scope.matchedItems=null;$scope.searchVal='';if($scope.results){$scope.results=null;angular.element(document.querySelector('.results-wrapper')).scope().$destroy();angular.element(document.querySelector('.results-wrapper')).remove();}$scope.data=DataService.getData(type);};$scope.emptyList=function(num){$scope.dropDownSel=$scope.matchedItems[num];$scope.activeSearch=false;$scope.searchVal=$scope.dropDownSel;$scope.matchedItems=null;};$scope.blurEvent=function(event){if(!angular.element(event.relatedTarget).hasClass('auto-list-item')){$scope.activeSearch = false;}};$scope.changeFunc=function(){if($scope.matchedItems){$scope.matchedItems=null;}if($scope.results){$scope.results=null;angular.element(document.querySelector('.results-wrapper')).scope().$destroy();angular.element(document.querySelector('.results-wrapper')).remove();} $scope.searchVal='';$scope.activeSearch=false;$scope.filterType=($scope.radioVal===$scope.optionType)?($scope.select==='federal')?'Agency':'State':'Domain Name';$scope.filteredItems=$scope.data.map(function(item){return item[$scope.filterType];}).filter(function(item,i,arr){return arr.indexOf(item)===i;}).sort(function(a,b){return a.localeCompare(b);});};$scope.autoCompleteItems=function(){$scope.matchedItems=$scope.filteredItems.filter(function(i){return i.toLowerCase().indexOf($scope.searchVal.toLowerCase())!==-1;});};$scope.aboutModal=function(){if(angular.element(document.querySelector('.about-container')).length===0){angular.element(document.querySelector('.container')).append($compile('<about></about>')($scope));}};$scope.getResults=function(type){var rFilter=$scope.filterType;if(!$scope.radioVal&&type!==null){alert("Please select a search type.");return false;}if(type==='search'&&!$scope.searchVal){alert("Please type a search value.");return false;} $scope.results=(type==='all')?$scope.data:$scope.data.filter(function(item,i){return item[rFilter].toLowerCase()===$scope.searchVal.toLowerCase();});if(rFilter!=='Domain Name'){$scope.results=$scope.results.reduce(function(arr,currentValue){var index=false;arr.forEach(function(item,i){if(item[rFilter]===currentValue[rFilter]){index=i;}});if(index===false){if(rFilter==="Agency"){arr.push({"Agency":currentValue.Agency,"Domains":[currentValue["Domain Name"]]});}else if(rFilter==="State"){arr.push({"State":currentValue.State,"Domains":[currentValue["Domain Name"]]});}return arr;} arr[index].Domains.push(currentValue["Domain Name"]);arr.sort(function(a,b){return a[rFilter].localeCompare(b[rFilter]);});return arr;},[]);$scope.results.forEach(function(item){item.Domains=item.Domains.sort(function(a,b){return a.localeCompare(b);});item["Domain Count"]=item.Domains.length;item.Percentage=+((item["Domain Count"]/$scope.data.length)*100).toFixed(2);});}if(rFilter==='Domain Name'){$scope.results.sort(function(a,b){return a[rFilter].localeCompare(b[rFilter]);});} $scope.results=($scope.results.length>1)?$scope.results:$scope.results[0];if(angular.element(document.querySelector('.results-wrapper')).length===1){angular.element(document.querySelector('.results-wrapper')).scope().$destroy();angular.element(document.querySelector('.results-wrapper')).remove();}angular.element(document.querySelector('.container')).append($compile('<results></results>')($scope.$new()));};}).directive('about',function(){return{templateUrl:'templates/about.html',controller:'mainCtrl',link:function($scope,$element,attrs){$scope.close=function(){angular.element($element).remove();};},replace:true};}).directive('filter',function(){return{restrict:'E',templateUrl:'templates/filter.html',scope:{opttype:'@',optprop:'@',optsafe:'@'},link:function(scope,element,attrs){scope.removeFilter=function(event){var a=element.attr('data-filter');scope.$parent.selectForm.currFilters.splice(scope.$parent.selectForm.options.indexOf(a),1);scope.$parent.selectForm.options.push(a);scope.$parent.selectForm.selectedOption=scope.$parent.selectForm.options[0];scope.$destroy();element.remove();};},replace:true};}).directive('results',function($compile,$filter,$location,$anchorScroll){return{restrict:'E',controller:'mainCtrl',templateUrl:'templates/results.html',link:function(scope,$element,attrs){scope.displayResults=scope.results;scope.filteredResults=scope.results;scope.resultsCount=scope.displayResults.length;scope.isFiltered=false;scope.activeResults=[];if(scope.results.length>1){if(scope.filterType==="Domain Name"){scope.allResults=scope.displayResults;scope.pagination={};scope.pageFunc=function(type){if(type==='original'){scope.pagination.pageMult=0;}else if(type==='minus'){scope.pagination.pageMult--;}else if(type==='plus'){scope.pagination.pageMult++;}scope.pagination.pageStartCount=scope.pagination.pageMult*500;scope.pagination.pageMultEnd=scope.pagination.pageMult+1;scope.pagination.pageEndCount=(scope.resultsCount>scope.pagination.pageMultEnd*500)?scope.pagination.pageMultEnd*500:scope.resultsCount;scope.displayResults=$filter('limitTo')(scope.allResults,scope.pagination.pageEndCount,scope.pagination.pageStartCount);return scope.displayResults;};scope.pageFunc('original');}}scope.sortType=scope.filterType;scope.sortFunc=function(val){return val[scope.sortType];};scope.reverse=false;if(scope.results.length>1){scope.selectForm={options:Object.keys(scope.results[0]).filter(function(item){return item!=="Domains";}),currFilters:[],selectOption:function(option){if(option!==null){var test,safe,optionType;test=scope.results[0];safe=option.replace(/\s+/g,"").toLowerCase();oType=typeof test[option];if(test.hasOwnProperty(option)&&typeof option==="string"){angular.element(document.querySelector('.filters')).append($compile('<filter opttype="'+oType.substr(0,3)+'" optprop="'+option+'" optsafe="'+safe+'"></filter')(scope.$new()));scope.selectForm.currFilters.push(option);scope.selectForm.options.splice(scope.selectForm.options.indexOf(option),1);scope.selectForm.selectedOption=null;}}},filterResults:function(){if (scope.filteredResults!==scope.results){scope.filteredResults = scope.results;}scope.selectForm.currFilters.forEach(function(item){var safe,currScope,childScope,filterFunc;safe=item.replace(/\s+/g,"").toLowerCase();currScope=angular.element(document.querySelector('.filter-'+safe)).isolateScope();childScope=currScope.$$childHead;filterFunc=function(value,index,array){if(currScope.opttype==='boo'){return(currScope.$$childTail.excludeCheck!==true)?value[item]===childScope.radValue:value[item]!==childScope.radValue;}else if(currScope.opttype==='str'){if(childScope.textValue!==null){var regex;if(childScope.radValue==='begins'){regex=new RegExp('^'+childScope.textValue,'i');return(currScope.$$childTail.excludeCheck!==true)?regex.test(value[item]):regex.test(value[item])===false;}else if(childScope.radValue==='ends'){if(currScope.optprop==='Domain Name'){regex=new RegExp(childScope.textValue+'\.','gi');return(currScope.$$childTail.excludeCheck!==true)?regex.test(value[item]):regex.test(value[item])===false;}else{regex=new RegExp(childScope.textValue+'$','i');return(currScope.$$childTail.excludeCheck!==true)?regex.test(value[item]):regex.test(value[item])===false;}}else if(childScope.radValue==='contains'){regex=new RegExp(childScope.textValue,'gi');return(currScope.$$childTail.excludeCheck!==true)?regex.test(value[item]):regex.test(value[item])===false;}}}else if(currScope.opttype==='num'){if(childScope.numValue!==null){if(currScope.radValue==='min'){return(currScope.$$childTail.excludeCheck!==true)?value[item]>=childScope.numValue:!(value[item]>=childScope.numValue)===true;}else if(childScope.radValue==='max'){return(currScope.$$childTail.excludeCheck!==true)?value[item]<=childScope.numValue:!(value[item]<=childScope.numValue)===true;}else if(childScope.radValue==='range'){if(childScope.numValue2!==null){return(currScope.$$childTail.excludeCheck!==true)?value[item]>=childScope.numValue&&value[item]<=childScope.numValue2:!(value[item]>=childScope.numValue&&value[item]<=childScope.numValue2)===true;}}}}};if(childScope.radValue!==null){scope.filteredResults=$filter('filter')(scope.filteredResults,filterFunc);}});scope.displayResults=scope.filteredResults;scope.resultsCount=scope.displayResults.length;if(scope.filterType==="Domain Name"){scope.allResults=scope.displayResults;scope.pageFunc('original');}},cancelFilter:function(){scope.filteredResults=scope.results;scope.displayResults=scope.results;scope.resultsCount=scope.displayResults.length;if(scope.filterType==="Domain Name"){scope.allResults=scope.displayResults;scope.pageFunc('original');}}};scope.selectForm.selectedOption=scope.selectForm.options[0];}scope.addDetails=function(event,index,type){var same,domains,num,newScope,currElem;currElem=angular.element(event.target);if(currElem.parent().parent().scope().hasData===true){delete currElem.parent().parent().scope().hasData;currElem.parent().next().scope().$destroy();currElem.parent().next().remove();}else{currElem.parent().parent().scope().hasData=true;newScope=scope.$new();newScope.currentItem=currElem.scope().item;if(scope.filterType!=='Domain Name'){domains=$compile('<div class="appended-data"><div class="domains-list"><div ng-repeat="domain in currentItem.Domains">{{domain}}</div></div></div>')(newScope);}else if(scope.filterType==='Domain Name'){domains=$compile('<div class="appended-data"><div class="domain-info-list"><div ng-repeat="(key, val) in currentItem"><span ng-if="key !== filterType"><b>{{key}}:</b> {{val}}</span></div></div>')(newScope);}currElem.parent().parent().append(domains);}};scope.sortBy=function(sortType){scope.sortType=sortType;scope.reverse=(scope.sortType===sortType)?!scope.reverse:false;};scope.goToTop=function(){$location.hash('top');$anchorScroll();};},replace:true};});